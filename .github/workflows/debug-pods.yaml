name: Debug Pod Logs
on:
  workflow_dispatch:
env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GKE_REGION }}
  CLUSTER: ${{ vars.GKE_CLUSTER_STAGING }}
  NAMESPACE: ${{ vars.K8S_NAMESPACE_STAGING }}
jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Install gcloud
        run: |
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli google-cloud-cli-gke-gcloud-auth-plugin
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV
      - name: Auth GCP
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/key.json
          gcloud auth activate-service-account --key-file=/tmp/key.json
          gcloud config set project ${{ env.PROJECT_ID }}
          gcloud container clusters get-credentials ${{ env.CLUSTER }} --region ${{ env.REGION }} --project ${{ env.PROJECT_ID }}
          rm -f /tmp/key.json
      - name: Get pod logs
        run: |
          echo "=== All Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          echo "=== API Service Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=eco-api --tail=80 --previous 2>&1 || kubectl logs -n ${{ env.NAMESPACE }} -l app=eco-api --tail=80 2>&1 || echo "No API logs"
          echo "=== Web Frontend Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app=eco-web --tail=80 --previous 2>&1 || kubectl logs -n ${{ env.NAMESPACE }} -l app=eco-web --tail=80 2>&1 || echo "No Web logs"
          echo "=== API Pod Events ==="
          kubectl describe pod -n ${{ env.NAMESPACE }} -l app=eco-api 2>&1 | grep -A 20 "Events:"
          echo "=== Web Pod Events ==="
          kubectl describe pod -n ${{ env.NAMESPACE }} -l app=eco-web 2>&1 | grep -A 20 "Events:"
