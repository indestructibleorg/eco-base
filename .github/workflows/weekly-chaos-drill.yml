name: Weekly Chaos Drill

on:
  schedule:
    # Every Monday 02:00 UTC (off-peak for asia-east1)
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      drill:
        description: 'Drill to run (all | flagger | eventbus)'
        required: false
        default: 'all'

concurrency:
  group: chaos-drill
  cancel-in-progress: false

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_REGION: ${{ secrets.GKE_REGION }}

jobs:
  # ── Job 1: EventBus Cross-Zone Distribution Verification ─────────────────
  eventbus-zone-drill:
    name: EventBus Cross-Zone Distribution
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.drill == 'all' || github.event.inputs.drill == 'eventbus' || github.event_name == 'schedule' }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER_NAME }}
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Run EventBus zone distribution drill
        run: |
          chmod +x tests/drill-eventbus-zone.sh
          bash tests/drill-eventbus-zone.sh

      - name: Upload drill report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: drill-eventbus-zone-${{ github.run_number }}
          path: tests/reports/drill-eventbus-zone-*.json
          retention-days: 90

      - name: Assert PASS
        run: |
          python3 -c "
          import json, sys, glob
          files = sorted(glob.glob('tests/reports/drill-eventbus-zone-*.json'))
          if not files:
              print('ERROR: No report found'); sys.exit(1)
          report = json.load(open(files[-1]))
          result = report.get('gate_result', 'FAIL')
          print(f'EventBus zone drill: {result}')
          if result != 'PASS':
              sys.exit(1)
          "

  # ── Job 2: Flagger Rollback Drill ────────────────────────────────────────
  flagger-rollback-drill:
    name: Flagger Rollback Drill
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.drill == 'all' || github.event.inputs.drill == 'flagger' || github.event_name == 'schedule' }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER_NAME }}
          location: ${{ env.GKE_REGION }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Run Flagger rollback drill
        run: |
          chmod +x tests/drill-flagger-rollback.sh
          bash tests/drill-flagger-rollback.sh

      - name: Upload drill report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: drill-flagger-rollback-${{ github.run_number }}
          path: tests/reports/drill-flagger-rollback-*.json
          retention-days: 90

      - name: Assert PASS
        run: |
          python3 -c "
          import json, sys, glob
          files = sorted(glob.glob('tests/reports/drill-flagger-rollback-*.json'))
          if not files:
              print('ERROR: No report found'); sys.exit(1)
          report = json.load(open(files[-1]))
          result = report.get('gate_result', 'FAIL')
          print(f'Flagger rollback drill: {result}')
          if result != 'PASS':
              sys.exit(1)
          "

  # ── Job 3: Drill Summary ─────────────────────────────────────────────────
  drill-summary:
    name: Weekly Drill Summary
    runs-on: ubuntu-latest
    needs: [eventbus-zone-drill, flagger-rollback-drill]
    if: always()
    steps:
      - name: Summarize results
        run: |
          echo "=== Weekly Chaos Drill Summary ==="
          echo "Run: ${{ github.run_number }}"
          echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "EventBus Zone Drill:    ${{ needs.eventbus-zone-drill.result }}"
          echo "Flagger Rollback Drill: ${{ needs.flagger-rollback-drill.result }}"
          echo ""
          if [[ "${{ needs.eventbus-zone-drill.result }}" != "success" ]] || \
             [[ "${{ needs.flagger-rollback-drill.result }}" != "success" ]]; then
            echo "STATUS: DEGRADED — one or more drills failed"
            exit 1
          else
            echo "STATUS: ALL PASS"
          fi

      - name: Create GitHub issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CHAOS DRILL FAILED] Weekly drill run #${context.runNumber}`,
              body: `## Weekly Chaos Drill Failure\n\n` +
                    `**Run**: ${context.runNumber}\n` +
                    `**Date**: ${new Date().toISOString()}\n\n` +
                    `### Results\n` +
                    `- EventBus Zone Drill: ${{ needs.eventbus-zone-drill.result }}\n` +
                    `- Flagger Rollback Drill: ${{ needs.flagger-rollback-drill.result }}\n\n` +
                    `### Action Required\n` +
                    `Review drill logs and remediate before next deployment window.\n\n` +
                    `[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['chaos-drill', 'incident', 'priority:high']
            });
