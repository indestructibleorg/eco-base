name: Increase SSD Quota

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'GCP region'
        required: true
        default: 'asia-east1'
      current_limit:
        description: 'Current SSD limit in GB'
        required: true
        type: number
      requested_limit:
        description: 'Requested SSD limit in GB'
        required: true
        type: number
      justification:
        description: 'Justification for quota increase'
        required: true
        type: string

permissions:
  contents: read
  issues: write

env:
  GCP_PROJECT: my-project-ops-1991

jobs:
  check-current-quota:
    name: Check Current Quota
    runs-on: ubuntu-latest
    outputs:
      current_usage: ${{ steps.check-quota.outputs.usage }}
      current_limit: ${{ steps.check-quota.outputs.limit }}
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Verify Python
        run: python3 --version

      - name: Install dependencies
        run: |
          pip install google-cloud-compute google-auth

      - name: Configure service account credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > /tmp/gcp-sa-key.json
          chmod 600 /tmp/gcp-sa-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-sa-key.json" >> $GITHUB_ENV

      - name: Check current quota
        id: check-quota
        env:
          REGION: ${{ github.event.inputs.region }}
        run: |
          python scripts/increase_ssd_quota.py \
            --action check \
            --region $REGION \
            --output-json > quota_status.json
          
          echo "usage=$(jq -r '.usage' quota_status.json)" >> $GITHUB_OUTPUT
          echo "limit=$(jq -r '.limit' quota_status.json)" >> $GITHUB_OUTPUT
          
          cat quota_status.json

      - name: Cleanup credentials
        if: always()
        run: rm -f /tmp/gcp-sa-key.json

  request-quota-increase:
    name: Request Quota Increase
    runs-on: ubuntu-latest
    needs: check-current-quota
    steps:
      - name: Checkout repository
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Verify Python
        run: python3 --version

      - name: Install dependencies
        run: |
          pip install google-cloud-compute google-auth

      - name: Configure service account credentials
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > /tmp/gcp-sa-key.json
          chmod 600 /tmp/gcp-sa-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-sa-key.json" >> $GITHUB_ENV

      - name: Request quota increase
        env:
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
        run: |
          python scripts/increase_ssd_quota.py \
            --action request \
            --region $REGION \
            --current-limit $CURRENT_LIMIT \
            --requested-limit $REQUESTED_LIMIT \
            --justification "$JUSTIFICATION" \
            --output-json > quota_request.json
          
          cat quota_request.json

      - name: Create issue for tracking
        env:
          REGION: ${{ github.event.inputs.region }}
          CURRENT_LIMIT: ${{ github.event.inputs.current_limit }}
          REQUESTED_LIMIT: ${{ github.event.inputs.requested_limit }}
          JUSTIFICATION: ${{ github.event.inputs.justification }}
          CURRENT_USAGE: ${{ needs.check-current-quota.outputs.current_usage }}
          REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'PY'
          import json
          import os
          import urllib.request

          with open("quota_request.json", "r", encoding="utf-8") as f:
              request_data = json.load(f)

          body = f"""## SSD Quota Increase Request

          **Region**: {os.environ['REGION']}
          **Current Limit**: {os.environ['CURRENT_LIMIT']} GB
          **Requested Limit**: {os.environ['REQUESTED_LIMIT']} GB
          **Current Usage**: {os.environ['CURRENT_USAGE']} GB

          **Justification**:
          {os.environ['JUSTIFICATION']}

          **Request ID**: `{request_data.get('request_id', 'N/A')}`
          **Status**: `{request_data.get('status', 'Submitted')}`

          ### Next Steps
          1. Monitor approval status in GCP Console
          2. Once approved, recreate production cluster
          3. Deploy production workloads

          ### References
          - [GCP Quotas Console](https://console.cloud.google.com/iam-admin/quotas?project=my-project-ops-1991)
          - [Quota Guide](docs/gcp-quota-guide.md)"""

          payload = json.dumps({
              "title": f"SSD Quota Increase Request - {os.environ['REGION']}",
              "body": body,
              "labels": ["quota", "infrastructure", "gcp"],
          }).encode("utf-8")

          req = urllib.request.Request(
              f"https://api.github.com/repos/{os.environ['REPOSITORY']}/issues",
              data=payload,
              method="POST",
              headers={
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "Content-Type": "application/json",
              },
          )
          with urllib.request.urlopen(req) as resp:
              if resp.status >= 300:
                  raise RuntimeError(f"Failed to create issue: HTTP {resp.status}")
          PY

      - name: Notify on success
        if: success()
        run: |
          echo "Quota increase request submitted successfully"
          echo "Request ID: $(jq -r '.request_id' quota_request.json)"

      - name: Cleanup credentials
        if: always()
        run: rm -f /tmp/gcp-sa-key.json
