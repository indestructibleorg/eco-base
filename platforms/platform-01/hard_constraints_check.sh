#!/bin/bash
# =============================================================================
# Hard Constraints Check Script
# =============================================================================
# 任何检查失败都返回非 0，阻断 CI
# 核心原则：工具缺失 = 直接 fail，检查失败 = 直接 fail
# =============================================================================

set -euo pipefail

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║           Hard Constraints Check (硬约束检查)                     ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""

FAILED=0

# -----------------------------------------------------------------------------
# 工具检查函数
# -----------------------------------------------------------------------------
require_cmd() {
    if ! command -v "$1" >/dev/null 2>&1; then
        echo "❌ missing required tool: $1"
        echo "   Install: pip install $1"
        exit 2
    fi
}

# -----------------------------------------------------------------------------
# 1. 类型检查（硬约束：失败 = 脚本失败）
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "1. 类型检查 (mypy --strict)..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

require_cmd mypy

mypy_exit=0
mypy --strict --warn-return-any eco-backend/app/ 2>&1 || mypy_exit=$?

if [ "$mypy_exit" -ne 0 ]; then
    echo ""
    echo "❌ 类型检查失败（mypy exit=$mypy_exit）"
    exit "$mypy_exit"
fi

echo "✅ 类型检查通过"

echo ""

# -----------------------------------------------------------------------------
# 2. 禁止模式检查 - 软初始化
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "2. 禁止模式检查 - 软初始化..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

SOFT_INIT=$(grep -rn "if not.*initialized.*return" --include="*.py" eco-backend/app/ 2>/dev/null || true)
if [ -n "$SOFT_INIT" ]; then
    echo "❌ 发现软初始化模式:"
    echo "$SOFT_INIT"
    FAILED=1
else
    echo "✅ 无软初始化模式"
fi

echo ""

# -----------------------------------------------------------------------------
# 3. 禁止模式检查 - 裸 except
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "3. 禁止模式检查 - 裸 except..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

BARE_EXCEPT=$(grep -rn "except:" --include="*.py" eco-backend/app/ 2>/dev/null | grep -v "except Exception as" || true)
if [ -n "$BARE_EXCEPT" ]; then
    echo "❌ 发现裸 except:"
    echo "$BARE_EXCEPT"
    FAILED=1
else
    echo "✅ 无裸 except"
fi

echo ""

# -----------------------------------------------------------------------------
# 4. 禁止模式检查 - 教学注释/TODO
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "4. 禁止模式检查 - 教学注释/TODO..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

TEACHING_COMMENTS=$(grep -rn "# TODO:\|# FIXME:\|# XXX:\|# 需要实现\|# 实际实现" --include="*.py" eco-backend/app/ 2>/dev/null || true)
if [ -n "$TEACHING_COMMENTS" ]; then
    echo "❌ 发现教学注释/TODO:"
    echo "$TEACHING_COMMENTS"
    FAILED=1
else
    echo "✅ 无教学注释/TODO"
fi

echo ""

# -----------------------------------------------------------------------------
# 5. 禁止模式检查 - 模拟数据
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "5. 禁止模式检查 - 模拟数据..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

MOCK_DATA=$(grep -rn "mock_data\|mock_values\|example_data\|sample_data" --include="*.py" eco-backend/app/ 2>/dev/null | grep -v "test_" || true)
if [ -n "$MOCK_DATA" ]; then
    echo "❌ 发现模拟数据:"
    echo "$MOCK_DATA"
    FAILED=1
else
    echo "✅ 无模拟数据"
fi

echo ""

# -----------------------------------------------------------------------------
# 6. 禁止模式检查 - 条件跳过
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "6. 禁止模式检查 - 条件跳过..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

CONDITIONAL_SKIP=$(grep -rn "if not.*available.*return\|if.*available.*return\|if not.*enabled.*return" --include="*.py" eco-backend/app/ 2>/dev/null || true)
if [ -n "$CONDITIONAL_SKIP" ]; then
    echo "❌ 发现条件跳过:"
    echo "$CONDITIONAL_SKIP"
    FAILED=1
else
    echo "✅ 无条件跳过"
fi

echo ""

# -----------------------------------------------------------------------------
# 7. 测试检查 - 无 skip
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "7. 测试检查 - 无 skip..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if [ -d "eco-backend/tests" ]; then
    TEST_SKIPS=$(grep -rn "@pytest.mark.skip\|pytest.skip" --include="*.py" eco-backend/tests/ 2>/dev/null || true)
    if [ -n "$TEST_SKIPS" ]; then
        echo "❌ 发现测试 skip:"
        echo "$TEST_SKIPS"
        FAILED=1
    else
        echo "✅ 无测试 skip"
    fi
else
    echo "⚠️ 测试目录不存在"
fi

echo ""

# -----------------------------------------------------------------------------
# 8. 运行测试（硬约束：失败 = 脚本失败）
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "8. 运行测试..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

require_cmd pytest

pytest_exit=0
python -m pytest tests/ -v --tb=short 2>&1 || pytest_exit=$?

if [ "$pytest_exit" -ne 0 ]; then
    echo ""
    echo "❌ 测试失败（pytest exit=$pytest_exit）"
    exit "$pytest_exit"
fi

echo "✅ 所有测试通过"
echo ""

# -----------------------------------------------------------------------------
# 9. 覆盖率检查（硬约束：失败 = 脚本失败，门槛 >= 80%）
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "9. 覆盖率检查 (>= 80%)..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

require_cmd coverage

# 先运行测试生成覆盖率数据
coverage_exit=0
python -m pytest tests/ --cov=eco-backend/app --cov-report=term-missing --cov-report=xml:coverage.xml 2>&1 || coverage_exit=$?

if [ "$coverage_exit" -ne 0 ]; then
    echo ""
    echo "❌ 测试运行失败（pytest exit=$coverage_exit）"
    exit "$coverage_exit"
fi

# 检查覆盖率门槛
echo ""
echo "检查覆盖率门槛 (>= 80%)..."
COVERAGE_THRESHOLD=80
coverage_report=$(coverage report --fail-under=$COVERAGE_THRESHOLD 2>&1) || {
    echo "❌ 覆盖率低于门槛 $COVERAGE_THRESHOLD%"
    echo "$coverage_report"
    exit 1
}

echo "✅ 覆盖率检查通过 (>= $COVERAGE_THRESHOLD%)"
echo ""

# -----------------------------------------------------------------------------
# 总结
# -----------------------------------------------------------------------------
echo "╔══════════════════════════════════════════════════════════════════╗"
if [ $FAILED -eq 0 ]; then
    echo "║              ✅ 所有硬约束检查通过                               ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    exit 0
else
    echo "║              ❌ 硬约束检查失败                                   ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    exit 1
fi
