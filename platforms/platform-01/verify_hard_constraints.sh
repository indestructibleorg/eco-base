#!/bin/bash
# =============================================================================
# Verify Hard Constraints - 强制验证流程
# =============================================================================
# 每次提交前必须运行，确保硬约束不会退化
# =============================================================================

set -euo pipefail

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║           强制验证流程 (Verify Hard Constraints)                  ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""

FAILED=0

# -----------------------------------------------------------------------------
# 1. 守卫测试
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "1. 运行守卫测试 (test_hard_constraints_guard.py)..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if python -m pytest tests/test_hard_constraints_guard.py -q 2>&1; then
    echo "✅ 守卫测试通过"
else
    echo "❌ 守卫测试失败"
    FAILED=1
fi

echo ""

# -----------------------------------------------------------------------------
# 2. 状态机测试
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "2. 运行状态机测试 (test_state_machine.py)..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if python -m pytest tests/test_state_machine.py -q 2>&1; then
    echo "✅ 状态机测试通过"
else
    echo "❌ 状态机测试失败"
    FAILED=1
fi

echo ""

# -----------------------------------------------------------------------------
# 3. 契约验证测试
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "3. 运行契约验证测试 (test_scripts_contracts_and_audit.py)..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if python -m pytest tests/test_scripts_contracts_and_audit.py -q 2>&1; then
    echo "✅ 契约验证测试通过"
else
    echo "❌ 契约验证测试失败"
    FAILED=1
fi

echo ""

# -----------------------------------------------------------------------------
# 4. 硬约束检查脚本
# -----------------------------------------------------------------------------
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "4. 运行硬约束检查脚本 (hard_constraints_check.sh)..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if bash hard_constraints_check.sh 2>&1; then
    echo "✅ 硬约束检查通过"
else
    echo "❌ 硬约束检查失败"
    FAILED=1
fi

echo ""

# -----------------------------------------------------------------------------
# 总结
# -----------------------------------------------------------------------------
echo "╔══════════════════════════════════════════════════════════════════╗"
if [ $FAILED -eq 0 ]; then
    echo "║              ✅ 全部验证通过 - 可以提交                          ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    exit 0
else
    echo "║              ❌ 验证失败 - 请修复后再提交                        ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    exit 1
fi
