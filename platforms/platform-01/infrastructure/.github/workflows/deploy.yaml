# =============================================================================
# CD Deploy Pipeline
# =============================================================================
# 此 workflow 負責:
# 1. 部署到 Staging 環境 (自動)
# 2. 部署到 Production 環境 (需要手動批准)
# 3. 使用 ArgoCD 進行 GitOps 部署
# =============================================================================

name: CD Deploy

on:
  workflow_run:
    workflows: ["CI Build"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy (default: latest)'
        required: false
        default: 'latest'

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  AR_REGISTRY: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/eco-base

permissions:
  contents: write
  id-token: write
  deployments: write

jobs:
  # ==========================================================================
  # 部署到 Staging
  # ==========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'workflow_dispatch' && 
       github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.your-domain.com  # 替換為您的域名
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_DEPLOY_SERVICE_ACCOUNT }}

      - name: Setup GCloud
        uses: google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ vars.GKE_CLUSTER_STAGING }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Update image tag in Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          IMAGE_TAG="${{ github.event.inputs.image_tag || github.sha }}"
          
          # 更新 Helm values 中的 image tag
          yq eval ".image.tag = \"$IMAGE_TAG\"" -i helm/eco-base/values-staging.yaml
          
          git add helm/eco-base/values-staging.yaml
          git commit -m "chore(deploy): update staging image tag to $IMAGE_TAG [skip ci]" || true
          git push

      - name: Sync ArgoCD Application
        run: |
          # 安裝 ArgoCD CLI
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64
          
          # 端口轉發 ArgoCD server
          kubectl port-forward svc/argocd-server -n argocd 8080:443 &
          sleep 5
          
          # 登入 ArgoCD
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          argocd login localhost:8080 --username admin --password "$ARGOCD_PASSWORD" --insecure
          
          # 同步應用程式
          argocd app sync eco-base-staging --prune --force
          
          # 等待部署完成
          argocd app wait eco-base-staging --health --timeout 600

      - name: Run smoke tests
        run: |
          # 等待服務準備就緒
          sleep 30
          
          # 運行煙霧測試
          curl -sf https://staging.your-domain.com/health || exit 1
          curl -sf https://staging.your-domain.com/api/health || exit 1

      - name: Create deployment
        uses: chrnorm/deployment-action@55729fcebec3d284f60f5bcabbd8376437d696d1  # v2.0.7
        if: success()
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: staging
          initial-status: success

  # ==========================================================================
  # 部署到 Production (需要手動批准)
  # ==========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://your-domain.com  # 替換為您的域名
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_DEPLOY_SERVICE_ACCOUNT }}

      - name: Setup GCloud
        uses: google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ vars.GKE_CLUSTER_PRODUCTION }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Update image tag in Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          
          # 更新 Helm values 中的 image tag
          yq eval ".image.tag = \"$IMAGE_TAG\"" -i helm/eco-base/values-production.yaml
          
          git add helm/eco-base/values-production.yaml
          git commit -m "chore(deploy): update production image tag to $IMAGE_TAG [skip ci]" || true
          git push

      - name: Sync ArgoCD Application
        run: |
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64
          
          kubectl port-forward svc/argocd-server -n argocd 8080:443 &
          sleep 5
          
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          argocd login localhost:8080 --username admin --password "$ARGOCD_PASSWORD" --insecure
          
          # 生產環境手動同步
          argocd app sync eco-base-production --prune
          argocd app wait eco-base-production --health --timeout 600

      - name: Run production smoke tests
        run: |
          sleep 30
          curl -sf https://your-domain.com/health || exit 1
          curl -sf https://your-domain.com/api/health || exit 1

      - name: Create deployment
        uses: chrnorm/deployment-action@55729fcebec3d284f60f5bcabbd8376437d696d1
        if: success()
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: production
          initial-status: success

  # ==========================================================================
  # 回滾 (失敗時)
  # ==========================================================================
  rollback-staging:
    name: Rollback Staging
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: failure()
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_DEPLOY_SERVICE_ACCOUNT }}

      - name: Setup GCloud
        uses: google-github-actions/setup-gcloud@6189d56e4096ee891640bb02ac264be376592d6a

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ vars.GKE_CLUSTER_STAGING }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Rollback deployment
        run: |
          kubectl rollout undo deployment/api -n staging
          kubectl rollout undo deployment/web -n staging
          kubectl rollout status deployment/api -n staging --timeout=300s
          kubectl rollout status deployment/web -n staging --timeout=300s
